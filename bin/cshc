#!/usr/bin/python3
import sys
import os.path

SELF_DIR = os.path.dirname(__file__)
sys.path.insert(0, os.path.join(SELF_DIR, "..", "lib"))

import argparse
import cshc

parser = argparse.ArgumentParser(description = 'cshc - C Shellcode Compiler')
parser.add_argument('srcpath', help = 'source code file')
parser.add_argument('-o', metavar = "<file>", dest = 'outpath',
                    help = 'place the output into <file>')
parser.add_argument('-a', '--arch', choices = cshc.archlist(), default = "x86",
                    help = 'target architecture')
parser.add_argument('-v', help = 'verbose mode', action = 'store_true',
                    dest = 'verbose')
#parser.add_argument('-e', '--encoder', choices = ("shikata_ga_nai",),
#                    help = 'encode shellcode')
parser.add_argument('-S', help = 'output assembly code.', action = 'store_true',
                    dest = 'compile_only')
args = parser.parse_args()

archobj = cshc.arch(args.arch, args.verbose)

if args.compile_only:
    archobj.compile_assembly(args.srcpath, args.outpath)
else:
    shellcode = archobj.compile_file(args.srcpath)

    if args.outpath is None:
        assert not args.verbose and args.outpath is None, "-v and no -o!"
        sys.stdout.buffer.write(shellcode)
        sys.exit(0)

    with open(args.outpath, "wb") as outfile:
        outfile.write(shellcode)
